<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ecologically-informed neural networks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ecologically-informed-nn_files/libs/clipboard/clipboard.min.js"></script>
<script src="ecologically-informed-nn_files/libs/quarto-html/quarto.js"></script>
<script src="ecologically-informed-nn_files/libs/quarto-html/popper.min.js"></script>
<script src="ecologically-informed-nn_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ecologically-informed-nn_files/libs/quarto-html/anchor.min.js"></script>
<link href="ecologically-informed-nn_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ecologically-informed-nn_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ecologically-informed-nn_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ecologically-informed-nn_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ecologically-informed-nn_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-you-will-learn" id="toc-what-you-will-learn" class="nav-link active" data-scroll-target="#what-you-will-learn">What you will learn</a></li>
  <li><a href="#prerequisite" id="toc-prerequisite" class="nav-link" data-scroll-target="#prerequisite">Prerequisite</a></li>
  <li><a href="#work-packages" id="toc-work-packages" class="nav-link" data-scroll-target="#work-packages">Work packages</a>
  <ul>
  <li><a href="#wp-a-process-based-model" id="toc-wp-a-process-based-model" class="nav-link" data-scroll-target="#wp-a-process-based-model"><strong>WP A</strong>: Process-based model</a>
  <ul class="collapse">
  <li><a href="#ecology" id="toc-ecology" class="nav-link" data-scroll-target="#ecology">Ecology</a></li>
  <li><a href="#dispersal" id="toc-dispersal" class="nav-link" data-scroll-target="#dispersal">Dispersal</a></li>
  <li><a href="#hints" id="toc-hints" class="nav-link" data-scroll-target="#hints">Hints</a></li>
  </ul></li>
  <li><a href="#wp-b-constructing-a-deep-sdm-in-julia" id="toc-wp-b-constructing-a-deep-sdm-in-julia" class="nav-link" data-scroll-target="#wp-b-constructing-a-deep-sdm-in-julia"><strong>WP B</strong>: Constructing a deep SDM in Julia</a>
  <ul class="collapse">
  <li><a href="#hints-1" id="toc-hints-1" class="nav-link" data-scroll-target="#hints-1">Hints</a></li>
  </ul></li>
  <li><a href="#wp-c-ecologically-informed-neural-network" id="toc-wp-c-ecologically-informed-neural-network" class="nav-link" data-scroll-target="#wp-c-ecologically-informed-neural-network"><strong>WP C</strong>: Ecologically-informed neural network</a>
  <ul class="collapse">
  <li><a href="#hints-2" id="toc-hints-2" class="nav-link" data-scroll-target="#hints-2">Hints</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="ecologically-informed-nn.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Ecologically-informed neural networks</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><img src="https://files.ipbes.net/ipbes-web-prod-public-files/styles/xl_1920_scale/azblob/2023-09/IAS%20website%20image.png.webp?itok=tVaiqu2q" class="img-fluid"></p>
<p>Invasive species pose major threats on nature, natureâ€™s contributions to people, and good quality of life (<a href="https://zenodo.org/records/3553579">IPBES, 2019</a>), with global annual costs estimated to exceed 423 billion USD. The management of invasive alien species requires the modelling of the species range and spread dynamics, in order to optimally allocate control effort. While current state-of-the-art modelling approaches such as deep learning species distribution model (deep SDM) can help in determining the potential niche of invasive alien species (e.g., <a href="https://www.nature.com/articles/s41467-024-48559-9">Brun et al.&nbsp;2024</a>), they assume that species are always in equilibrium with their environment, neglecting key transient ecological processes such as demographic changes and dispersal. This oversight is problematic, because these processes are crucial in determining the establishment of a species in a novel environment.</p>
<p>The proposed project aims to fill this gap by developing an ecologically-informed neural network, following a physics-informed neural network approach (see e.g.<a href="https://www.nature.com/articles/s41467-024-48559-9">Raissi et al.&nbsp;2019</a>).</p>
<p><img src="https://benmoseley.blog/wp-content/uploads/2021/08/pinn-1536x608.png" class="img-fluid"></p>
<p>Specifically, we will build a process-based dynamical model, that we will couple to a deep SDM. The resulting approach will allow to inform the process-based model with presence-absence data, generating a data-driven dynamical forecast of species invasion.</p>
<p>Julia is great for physics-informed approaches, because it allows to quickly build fast process-based models. Because Julia is an AD-pervasive language, these process-based models can be further differentiated, so that you could eventually calibrate its parameters against the ecological data at hand.</p>
<section id="what-you-will-learn" class="level2">
<h2 class="anchored" data-anchor-id="what-you-will-learn">What you will learn</h2>
<ul>
<li>Building a simple deep SDM</li>
<li>Building a simple process-based model</li>
<li>Scientific machine learning</li>
</ul>
</section>
<section id="prerequisite" class="level2">
<h2 class="anchored" data-anchor-id="prerequisite">Prerequisite</h2>
<ul>
<li><a href="https://book.sciml.ai/notes/03-Introduction_to_Scientific_Machine_Learning_through_Physics-Informed_Neural_Networks/">Read this tutorial to understand what is a physics-informed neural network and how to code it in Julia</a></li>
<li><a href="https://lux.csail.mit.edu/dev/tutorials/beginner/4_SimpleChains">Have a look at this Lux tutorial on how to train a MNIST classifier</a></li>
</ul>
</section>
<section id="work-packages" class="level2">
<h2 class="anchored" data-anchor-id="work-packages">Work packages</h2>
<p>The different work packages below can be addressed independently and distributed among different teams. The team could collaborate on a public repository.</p>
<section id="wp-a-process-based-model" class="level3">
<h3 class="anchored" data-anchor-id="wp-a-process-based-model"><strong>WP A</strong>: Process-based model</h3>
<p>The goal is to construct a model which simulates the dynamics of species abundance on a landscape. Given a landscape consisting of <span class="math inline">\(P\)</span> patches <span class="math inline">\(\{p_1, \dots, p_P \}\)</span>, we want to model the dynamics of the population abundance vector <span class="math inline">\({\bf n}_{t} = (n_{1, t}, \dots, n_{P, t})\)</span> where <span class="math inline">\(n_{i, t}\)</span> corresponds to the population density on <span class="math inline">\(p_i\)</span>.</p>
<p>We will assume that the population experiences a logistic growth, and that it is subject to dispersal. We will use a difference equation model to express these processes</p>
<p><span class="math display">\[
n_{i, t+1} = n_{i, t} + [F({\bf n_t})]_i,
\]</span> where <span class="math display">\[
[F({\bf n_t})]_i  = \mathcal{E}(n_{i, t}) + [\mathcal{D}({\bf n_t})]_i.
\]</span> Here, <span class="math inline">\(\mathcal{E}\)</span> coresponds to the ecological dynamics, <span class="math display">\[
\mathcal{E}(n_{i, t}) = n_{i, t}(1 - \frac{n_{i, t}}{K_i})
\]</span> with <span class="math inline">\(K_i\)</span> the carrying capacity on patch <span class="math inline">\(p_i\)</span>, and where <span class="math inline">\(\mathcal{D}\)</span> is the dispersal kernel <span class="math display">\[
[\mathcal{D}({\bf n_t})]_i = \left[ \sum_j  u_{j, t} m_{j, i} - \sum_j  u_{i, t} m_{i, j}\right]
\]</span></p>
<p>with <span class="math inline">\(m_{j,i}\)</span> the proportion of individuals migrating from <span class="math inline">\(p_j\)</span> to <span class="math inline">\(p_i\)</span>. The first term corresponds to incoming individuals, the second to leaving individuals.</p>
<section id="ecology" class="level4">
<h4 class="anchored" data-anchor-id="ecology">Ecology</h4>
<p>We will assume that <span class="math display">\[
K_{i} = e^{-\kappa(T_i - T^\star)^2}
\]</span> where <span class="math inline">\(T_i\)</span> is the temperature on patch <span class="math inline">\(p_i\)</span>, <span class="math inline">\(T^\star\)</span> is the optimal temperature for the species, and <span class="math inline">\(\kappa\)</span> defines how the carrying capacity decreases under sub-optimal conditions.</p>
</section>
<section id="dispersal" class="level4">
<h4 class="anchored" data-anchor-id="dispersal">Dispersal</h4>
<p>We will assume that <span class="math display">\[
m_{i,j} = \begin{cases}
m \, e^{-d_{i,j}/\alpha}, &amp; \text{if } i \neq j \\
0, &amp; \text{if } i = j
\end{cases}
\]</span> where <span class="math inline">\(m\)</span> is the migration rate and <span class="math inline">\(d_{i,j}\)</span> is the distance between <span class="math inline">\(p_i\)</span> and <span class="math inline">\(p_j\)</span>.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Your task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Implement this model! For this, youâ€™ll need to create a <code>DynSDM</code> struct. This struct should be used with the <code>simulate</code> function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">DynSDM</span>(<span class="op">...</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">simulate</span>(model, u0, ntsteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Given a <code>model</code> and an initial abundance vector <code>u0</code> and the number of time steps <code>ntsteps</code>, this function returns a vector of size <code>ntsteps</code> containing abundance vectors with the same shape as <code>u0</code> for each of the time steps investigated.</p>
<p>The dynamics should look as follows:</p>
<p><img src="data/anim.gif" class="img-fluid"></p>
</div>
</div>
</section>
<section id="hints" class="level4">
<h4 class="anchored" data-anchor-id="hints">Hints</h4>
<p>You are given a <code>utils.jl</code> file, which contains helper functions to aid your work. Important functions are detailed in the boxes below.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loading the data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You will use temperature data from CHELSA. Run the following snippet. It will download the <code>bio1</code> raster from CHELSA, and load it.</p>
<div id="5767ac4b" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">"project_src/utils.jl"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> <span class="fu">load_raster</span>()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Defining the landscape
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>utils.jl</code> file provides you with a <code>Landscape</code> struct. This struct is very useful, because it calculates the distance between all pixels of a raster. Use it in your model!</p>
<p>Here is a snippet of how you can use it:</p>
<div id="86a4edbd" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>landscape <span class="op">=</span> <span class="fu">Landscape</span>(temp)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>landscape.dists</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>landscape.dists[i, j]</code> corresponds to the <code>d_{i,j}</code> coefficient, i.e.&nbsp;the distance between pixel <code>i</code> and <code>j</code>.</p>
<p>The method <code>get_raster_values</code> allows you to transform a flat vector into a raster corresponding to the associated landscape.</p>
<p>For illustration purposes, here we plot the distance of all patch to the 400th patch in the landscape:</p>
<div id="939f464e" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>distances_to_400 <span class="op">=</span> <span class="fu">get_raster_values</span>(landscape.dists[<span class="fl">400</span>,<span class="op">:</span>], landscape)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(distances_to_400)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Numerical values
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div id="8ab161c4" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>T0 <span class="op">=</span> <span class="fl">4</span>. <span class="co"># optimal growth temperature</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Îº <span class="op">=</span> <span class="fl">1</span>.</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Î± <span class="op">=</span> <span class="fl">4</span>. <span class="co"># mean dispersal distance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Initial conditions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We suggest using the following initial conditions:</p>
<div id="91022987" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fu">lookup</span>(temp, X)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="fu">lookup</span>(temp, Y)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>x_0 <span class="op">=</span> x[<span class="fu">floor</span>(<span class="dt">Int</span>, <span class="fu">length</span>(x)<span class="op">/</span><span class="fl">2</span>)]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>y_0 <span class="op">=</span> y[<span class="fu">floor</span>(<span class="dt">Int</span>, <span class="fu">length</span>(y)<span class="op">/</span><span class="fl">2</span>)]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">2</span>.</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fl">1</span>.</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>u0_raster <span class="op">=</span> @. <span class="fu">exp</span>(<span class="op">-</span> a <span class="op">*</span> ((x <span class="op">-</span> x_0)<span class="op">^</span><span class="fl">2</span> <span class="op">+</span> (y<span class="op">-</span>y_0)<span class="op">^</span><span class="fl">2</span>)) <span class="op">*</span> <span class="fu">exp</span>(<span class="op">-</span> b <span class="op">*</span> (temp <span class="op">-</span> T0)<span class="op">^</span><span class="fl">2</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(u0_raster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Defining state variables
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>It will be easier to handle a flat vector for calculating the dynamics.</p>
<div id="c30b8060" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>u0 <span class="op">=</span> u0_raster[<span class="op">:</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But you can use the following helper to transform <code>u0</code> or any state variable vector into a raster</p>
<div id="db203f6f" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">get_raster_values</span>(u0, landscape))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dispersal kernel
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Implementing the dispersal kernel is not trivial - you need to do it write to get performance. Consider using the following implementation:</p>
<div id="049507ce" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>disp_proximities <span class="op">=</span> <span class="fu">sparse</span>(<span class="fu">disp_kern</span>.(landscape.dists)) <span class="co"># we transform the distances in proximities</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> <span class="op">-</span> m <span class="op">*</span> (I <span class="op">-</span> (disp_proximities <span class="op">./</span> <span class="fu">sum</span>(disp_proximities,dims<span class="op">=</span><span class="fl">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you need to convince yourself that <code>D * u</code> exactly equals <span class="math inline">\(\mathcal{D}({\bf n}_t)\)</span>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>DynSDM</code> specs
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You probably want to define a structure of the sort</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="pp">@kwdef</span> <span class="kw">struct</span> DynSDM{LD,KK,DD} <span class="op">&lt;:</span><span class="dt"> AbstractDynModel</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    landscape<span class="op">::</span><span class="dt">LD</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    K<span class="op">::</span><span class="dt">KK</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    D<span class="op">:</span>DD</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>that can be instantiated with a function</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">build_dyn_model</span>(landscape<span class="op">::</span><span class="dt">Landscape</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This structure will ensure easy access to <code>K</code> and <code>D</code>, while storing the landscape so that you can project flat state variable vectors to a raster.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Optional task: model differentiability and mechanistic inference
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Is your model differentiable? Try whether you can obtain the derivative of its output with respect to its parameters. A good idea is to embed the modelâ€™s parameters in a <code>ComponentArray</code>.</p></li>
<li><p>Once the model is differentiable, generate data and use <code>Optimisers.jl</code> to find back the parameters that have generated the data.</p></li>
</ul>
</div>
</div>
<!-- 
You could consider any sort of model, but here are some examples
- The discrete reaction diffusion model from [Bonneau et al. 2017](https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecs2.1979), where individuals experience a logistic growth with a locally defined carrying capacity $K_i$ that depends on the landscape characteristics, and where some individuals disperse to neighboring vertices.
- The metapopulation model from [Hanski et al. 2003](https://www.nature.com/articles/35008063)  -->
</section>
</section>
<section id="wp-b-constructing-a-deep-sdm-in-julia" class="level3">
<h3 class="anchored" data-anchor-id="wp-b-constructing-a-deep-sdm-in-julia"><strong>WP B</strong>: Constructing a deep SDM in Julia</h3>
<p>The goal is to construct a deep SDM <span class="math inline">\(\text{NN}\)</span> which can predict the species distribution at time <span class="math inline">\(t\)</span>, given an array of absence-presence observations.</p>
<p><span class="math display">\[
\hat y = \text{NN}(\text{long},\text{lat},E,t)
\]</span></p>
<p>Given that the species range changes over time, spatial coordinates <span class="math inline">\((long, lat)\)</span>, environmental predictors <span class="math inline">\(E\)</span> (for this exercise, weâ€™ll use <code>bio1</code> from CHELSA), and time <span class="math inline">\(t\)</span> will be used as inputs to the SDM.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Your task
</div>
</div>
<div class="callout-body-container callout-body">
<p>You are given a synthetic presence absence dataset (see green box below.) Build a <code>Lux.jl</code> model that predicts the species distribution over the whole spatial domain defined by <code>raster = load_data()</code>, for each time steps in the dataset.</p>
<!-- You'll need to build a function 
```julia
train(;nn, 
        PA_data, 
        optim, 
        n_epochs)
``` -->
</div>
</div>
<section id="hints-1" class="level4">
<h4 class="anchored" data-anchor-id="hints-1">Hints</h4>
<p>You have access to a <code>utils.jl</code> file containing helper functions to assist in your task. Important functions are detailed in the sections below.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
General idea
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Your script should implement the following key functions:</p>
<ul>
<li><strong><code>build_model</code></strong>: Constructs and returns a <code>Lux</code> model.</li>
<li><strong><code>preprocess_data</code></strong>: Normalizes raw data for neural network training.</li>
<li><strong><code>loss</code></strong>: Defines the loss function for training.</li>
<li><strong><code>train</code></strong>: The main function that iterates over batches to update model parameters.</li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loading and pre-processing the absence-presence data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You will work with a synthetic presence-absence (PA) dataset for a virtual invasive species, located in <code>data/PA_data.csv</code>. This dataset is derived from a process-based modelâ€™s true abundance data.</p>
<ol type="1">
<li><strong>Load the data</strong>: Start by loading the <code>.csv</code> file into a <code>DataFrame</code>.</li>
<li><strong>Preprocess the data</strong>: Implement a <code>process_data(df; train_split=0.9, batchsize=128)</code> function to:
<ul>
<li>Normalize the features.</li>
<li>Split the data into training and testing sets.</li>
<li>Return <code>train_dataloader</code> and <code>test_dataloader</code> for model training.</li>
</ul></li>
</ol>
<p>Use <code>splitobs</code> and <code>DataLoader</code> from <code>MLUtils.jl</code> for data handling, and <code>Standardizer</code> from <code>MLJ</code> for standardization.</p>
<!-- But feel free to work with real data if you have an idea! -->
<!-- ![](data/PA.gif) -->
<!-- 
You may want to create a function that processes this dataframe so that
1. the resulting processed data is normalized 
2. you can iterate over it -->
<!-- Notice how the number of samples increases over time. You should correct for this bias! -->
<!-- ### True population abundance data
![](data/anim.gif)
in `data/true_abundance_data.jld2`

You may use this dataset to evaluate your model, but not for training! -->
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ðŸ†˜ <em>Advanced help</em>: loading and pre-processing the absence-presence data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>To normalize <code>data</code> (a DataFrame), you can use</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>standardizer <span class="op">=</span> <span class="fu">machine</span>(<span class="fu">Standardizer</span>(), data)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fit!</span>(standardizer)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> (MLJ.<span class="fu">transform</span>(standardizer, pred_data) <span class="op">|&gt;</span> <span class="dt">Array</span>)<span class="ch">' .|&gt; Float32</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>splitobs</code> may be used as such:</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(x_train, y_train), (x_test, y_test) <span class="op">=</span> <span class="fu">splitobs</span>((x_data, y_data); at<span class="op">=</span>train_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>a <code>DataLoader</code> can be defined as such</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DataLoader</span>(<span class="fu">collect</span>.((x_train, y_train)); batchsize, shuffle<span class="op">=</span><span class="cn">true</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Neural network architecture and loss
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Create a Multi-Layer Perceptron (MLP) using <code>Lux.Chain</code> with <code>Dense</code> layers. Consider using a <code>BatchNorm</code> layer for faster training. The final activation function should be <code>Lux.sigmoid</code>, outputting a probability <code>Å·</code>, which should be compared against the binary absence-presence target <code>y</code> using <code>Flux.binarycrossentropy</code>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ðŸ†˜ <em>Advanced help</em>: Neural network architecture and loss
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Consider using the following function to create your model.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">build_model</span>(; npred, hidden_nodes, hidden_layers, dev<span class="op">=</span>cpu)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="fu">Chain</span>(<span class="fu">Dense</span>(npred, hidden_nodes),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">BatchNorm</span>(hidden_nodes),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        [<span class="fu">Dense</span>(hidden_nodes, hidden_nodes, tanh) for _ <span class="op">âˆˆ</span> <span class="fl">1</span><span class="op">:</span>hidden_layers<span class="op">-</span><span class="fl">1</span>]<span class="op">...</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Dense</span>(hidden_nodes, <span class="fl">1</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        Lux.sigmoid</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Observe that <code>loss</code> should have the signature <code>loss(model, ps, st, data)</code> to be a valid function to be trained with the <code>Lux.Training</code> API (see box below):</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Training.<span class="fu">single_train_step!</span>(<span class="fu">AutoZygote</span>(), loss, data, train_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>loss</code> should return a tuple: <code>l, st, (;)</code>, with <code>l</code> the loss value and <code>st</code> the state of the model</li>
<li>Remember how to evaluate a <code>Lux</code> model:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>yÌ‚, st <span class="op">=</span> Lux.<span class="fu">apply</span>(model, x, ps, st)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Training your network
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Within the <code>train</code> function:</p>
<ol type="1">
<li><strong>Initialize Training State</strong>:</li>
</ol>
<div class="sourceCode" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>train_state <span class="op">=</span> Training.<span class="fu">TrainState</span>(rng, model, opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>opt</code> could be the Adam optimizer</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optimisers</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> <span class="fu">Adam</span>(<span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and <code>rng</code> is a random number generator</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_generator</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li><p><strong>Training loop</strong>:</p>
<ul>
<li>Iterate over the data batches:</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> data <span class="kw">in</span> train_dataloader</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    (_, l, _, train_state) <span class="op">=</span> Training.<span class="fu">single_train_step!</span>(<span class="fu">AutoZygote</span>(), loss, data, train_state)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which will update the model parameters for each batch, and an outer loop to iterate multiple times over your data (epochs):</p>
<ul>
<li>Repeat for multiple epochs:</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n_epochs</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Return the trained model parameters and state:</li>
</ul>
<pre><code>(train_state.parameters,  Lux.testmode(train_state.states))</code></pre></li>
</ol>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Projecting the modelâ€™s predictions spatially
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>To project the deep SDM spatially, youâ€™ll need the <code>temp</code> raster, that you can obtain by running the following snippet. This will download the <code>bio1</code> (mean annual temperature) raster from CHELSA, and load it.</li>
</ul>
<div id="36a37a85" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">"project_src/utils.jl"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> <span class="fu">load_raster</span>()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>With this raster, construct a dataframe containing temp values with associated longitude, latitude, and time. The following snippet permits to create a dataframe with (<code>x, y, temp</code>).</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>    loc_xy <span class="op">=</span> <span class="fu">DimPoints</span>(temp)[<span class="op">:</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    temp_vec <span class="op">=</span>  temp[<span class="op">:</span>]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    df_xytemp <span class="op">=</span> <span class="fu">DataFrame</span>(<span class="fu">vcat</span>(<span class="fu">hcat</span>(<span class="fu">collect</span>.(loc_xy)<span class="op">...</span>)<span class="ch">', temp_vec'</span>), [<span class="op">:</span>x, <span class="op">:</span>y, <span class="op">:</span>temp])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>With this dataframe, you can predict a flat vector of abundance, which you can map back to a raster with the helper function <code>get_raster_values</code>:</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>yÌ‚, _ <span class="op">=</span> Lux.<span class="fu">apply</span>(nn, pred_all, ps, st)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>predicted <span class="op">=</span> <span class="fu">reshape</span>(yÌ‚, <span class="op">:</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>landscape <span class="op">=</span> <span class="fu">Landscape</span>(temp)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>urast <span class="op">=</span> <span class="fu">get_raster_values</span>(predicted, landscape)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(urast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- Feel free to use additional predictors, by modifying the `load_raster` function. -->
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Optional task: Hyperparameter optimisation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Hyperparameters of a neural network model are parameters that are not learned during training but are set by the user before training. The hyperparameters define the structure and behavior of the neural network and influence how the model learns from the input data. Some resources: - <a href="https://github.com/baggepinnen/Hyperopt.jl">Hyperopt.jl</a>.</p>
<ul>
<li><a href="https://towardsdatascience.com/a-conceptual-explanation-of-bayesian-model-based-hyperparameter-optimization-for-machine-learning-b8172278050f">A Conceptual Explanation of Bayesian Hyperparameter Optimization for Machine Learning</a></li>
</ul>
</div>
</div>
</section>
</section>
<section id="wp-c-ecologically-informed-neural-network" class="level3">
<h3 class="anchored" data-anchor-id="wp-c-ecologically-informed-neural-network"><strong>WP C</strong>: Ecologically-informed neural network</h3>
<p>The objective is to improve the performance of the deep SDM by additionally constraining it with a process-based model.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Your task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Extend the <code>loss</code> function used to train the deep SDM developed in <strong>WP B</strong> by constraining it with the process-based model developed in <strong>WP A</strong>. Assume perfect knowledge of the dynamics of the species (i.e., use the process-based model with true generating parameters, see <strong>WP A</strong>).</p>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Advanced task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now assume that you only have partial knowledge of the dynamics (i.e., you know the function form of the dynamical system, but not the true parameter values). Youâ€™ll need to consider the parameters of the mechanistic model as additional parameters to be learnt, on top of that of the deep SDM.</p>
</div>
</div>
<section id="hints-2" class="level4">
<h4 class="anchored" data-anchor-id="hints-2">Hints</h4>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loss function
</div>
</div>
<div class="callout-body-container callout-body">
<p>The extended loss could have the form</p>
<p><span class="math display">\[
\mathcal{L} = \sum_i l(\hat{y_{i,t_i}}, y_{i,t_i}) + \sum_{i,j} \left[\hat y_{i, t_{j+1}} - [F({\bf \hat y}_{t_j})]_i\right]^2
\]</span> where <span class="math inline">\(l\)</span> is the binary cross entropy loss.</p>
</div>
</div>
<!-- 
Once this is done, check how good are your predictions outside the training range by predicting with

```julia
simulate(model, f[end](pred), 1)
```

which will predict ${\bf n}_{T+1}$.

 -->
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>